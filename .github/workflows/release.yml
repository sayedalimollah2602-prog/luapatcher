name: Build & Release

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

permissions:
  contents: write

env:
  QT_VERSION: '6.6.0'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.27.x'

    - name: Setup Ninja
      uses: ashutoshvarma/setup-ninja@v1.1
      
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        arch: 'win64_msvc2019_64'
        modules: 'qtwebengine qtwebchannel qtpositioning qtdeclarative'
        
    - name: Build SteamLuaPatcher (Dynamic)
      shell: pwsh
      run: |
        # Clean and create build directory
        if (Test-Path build) { Remove-Item -Recurse -Force build }
        New-Item -ItemType Directory -Force -Path build
        Set-Location build
        
        Write-Host "Configuring CMake..."
        cmake -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DBUILD_STATIC=OFF `
          ..
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "CMake configuration failed!"
          exit 1
        }
        
        Write-Host "Building..."
        cmake --build . --config Release
        
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Build failed!"
          exit 1
        }

    - name: Deploy Qt Dependencies
      shell: pwsh
      run: |
        # Create dist folder
        New-Item -ItemType Directory -Force -Path dist
        
        # Copy executable
        Copy-Item "build\SteamLuaPatcher.exe" "dist\"
        
        # Run windeployqt
        $windeployqt = "windeployqt.exe" 
        # (windeployqt is in path due to install-qt-action)
        
        Write-Host "Running windeployqt..."
        # We need to include webengine explicitly sometimes or just let it auto-discover
        & $windeployqt --release --compiler-runtime --no-translations --no-opengl-sw "dist\SteamLuaPatcher.exe"
        
    - name: Install Inno Setup
      shell: pwsh
      run: |
        choco install innosetup --no-progress
        
    - name: Compile Installer
      shell: pwsh
      run: |
        # Inno Setup is installed to "C:\Program Files (x86)\Inno Setup 6"
        $iscc = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        & $iscc setup.iss
        
    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SteamLuaPatcher-Installer
        path: dist/SteamLuaPatcher_Setup.exe
        retention-days: 30

    - name: Check for Release
      id: check_release
      if: github.event_name == 'push'
      shell: pwsh
      run: |
        $msg = "${{ github.event.head_commit.message }}"
        if ($msg -match "(?i)release:\s*v?([\d\.]+)") {
          $version = $matches[1]
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "IS_RELEASE=true" >> $env:GITHUB_OUTPUT
          Write-Host "Release detected: v$version"
        } else {
          echo "IS_RELEASE=false" >> $env:GITHUB_OUTPUT
          Write-Host "Not a release commit"
        }

    - name: Generate Changelog
      id: changelog
      if: steps.check_release.outputs.IS_RELEASE == 'true'
      shell: pwsh
      run: |
        $msg = "${{ github.event.head_commit.message }}"
        $parts = $msg -split " - "
        $changelog = ""
        foreach ($part in $parts) {
          if ($part -match "^release:") { continue }
          $part = $part.Trim()
          if ($part) {
            $changelog += "- $part`n"
          }
        }
        if (-not $changelog) {
          $changelog = "- Bug fixes and improvements"
        }
        
        # Escape for GitHub Actions output
        $changelog = $changelog -replace '%', '%25' -replace '\n', '%0A' -replace '\r', '%0D'
        echo "LOGS=$changelog" >> $env:GITHUB_OUTPUT

    - name: Create Release
      if: steps.check_release.outputs.IS_RELEASE == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.check_release.outputs.VERSION }}
        name: Release v${{ steps.check_release.outputs.VERSION }}
        body: |
          ## What's New
          ${{ steps.changelog.outputs.LOGS }}
          
          ## Download & Install
          1. Download `SteamLuaPatcher_Setup.exe` below
          2. Run the installer
          3. Launch via Desktop Shortcut
        files: |
          dist/SteamLuaPatcher_Setup.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
