name: Release Build

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      changelog:
        description: 'Changelog/Release notes (use " - " to separate items)'
        required: false
        type: string
        default: 'Manual release'

permissions:
  contents: write

jobs:
  build-and-release:
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, 'release:')
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw'
        modules: 'qtnetworkauth'
        cache: true

    - name: Setup MinGW
      run: |
        choco install mingw --version=11.2.0.07112021 --force -y
        echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.27.x'

    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release ..
      shell: cmd

    - name: Build
      run: |
        cd build
        cmake --build . --config Release
      shell: cmd

    - name: Create Distribution Package
      run: |
        mkdir dist
        copy build\SteamLuaPatcher.exe dist\
        if exist logo.ico copy logo.ico dist\
        cd dist
        windeployqt SteamLuaPatcher.exe --release --no-translations
      shell: cmd

    - name: Create Installer (Optional - using NSIS)
      run: |
        echo "Skipping installer creation - direct exe distribution"
      shell: cmd

    - name: Package Release
      run: |
        cd dist
        7z a ..\SteamLuaPatcher-Windows.zip *
      shell: cmd

    - name: Extract Version from Commit Message
      id: get_info
      shell: pwsh
      run: |
        # Check if this is a manual trigger
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
            echo "VERSION=$version" >> $env:GITHUB_OUTPUT
            echo "Manual trigger - Version: $version"
        } else {
            # Extract from commit message
            $msg = "${{ github.event.head_commit.message }}"
            if ($msg -match "(?i)release:\s*v?([\d\.]+)") {
                $version = $matches[1]
                echo "VERSION=$version" >> $env:GITHUB_OUTPUT
                echo "Commit trigger - Found version: $version"
            } else {
                echo "VERSION=latest" >> $env:GITHUB_OUTPUT
                echo "No specific version found, using 'latest'"
            }
        }

    - name: Generate Changelog
      id: changelog
      shell: pwsh
      run: |
        # Check if this is a manual trigger
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $changelog = "${{ github.event.inputs.changelog }}"
            if ($changelog) {
                # Split by " - " if multiple items
                $parts = $changelog -split " - "
                $formattedLog = ""
                foreach ($part in $parts) {
                    $part = $part.Trim()
                    if ($part) {
                        $formattedLog += "- $part`n"
                    }
                }
                $changelog = $formattedLog
            } else {
                $changelog = "- Manual release"
            }
            echo "Manual trigger changelog"
        } else {
            # Extract from commit message
            $msg = "${{ github.event.head_commit.message }}"
            $parts = $msg -split " - "
            $changelog = ""
            foreach ($part in $parts) {
                if ($part -match "^release:") { continue }
                $changelog += "- $part`n"
            }
            if (-not $changelog) {
                $changelog = $msg
            }
        }
        
        # Escape for GitHub Actions output
        $changelog = $changelog -replace '%', '%25' -replace '\n', '%0A' -replace '\r', '%0D'
        echo "LOGS=$changelog" >> $env:GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_info.outputs.VERSION }}
        name: Release v${{ steps.get_info.outputs.VERSION }}
        body: |
          ## Changes
          ${{ steps.changelog.outputs.LOGS }}
          
          ## Installation
          1. Download `SteamLuaPatcher-Windows.zip`
          2. Extract the archive
          3. Run `SteamLuaPatcher.exe`
          
          ## Requirements
          - Windows 10/11
          - Visual C++ Redistributable (usually pre-installed)
        files: |
          SteamLuaPatcher-Windows.zip
          dist/SteamLuaPatcher.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
